# QuickJax Development & Maintenance Guide

[中文版](DEVELOPMENT.zh-CN.md)

This document is intended for developers and maintainers. It describes QuickJax's architecture, technical decisions, known issues, and troubleshooting methods in detail.

---

## Table of Contents

1. [Project Overview](#1-project-overview)
2. [Directory Structure](#2-directory-structure)
3. [Architecture & Data Flow](#3-architecture--data-flow)
4. [JavaScript Layer](#4-javascript-layer)
5. [Python Layer](#5-python-layer)
6. [Build Process](#6-build-process)
7. [Key Technical Decisions & Pitfalls](#7-key-technical-decisions--pitfalls)
8. [Testing](#8-testing)
9. [Publishing & Packaging](#9-publishing--packaging)
10. [Troubleshooting](#10-troubleshooting)
11. [Extension Guide](#11-extension-guide)

---

## 1. Project Overview

QuickJax is a pure-Python MathJax v4 renderer.

**Core idea**: Bundle the entire MathJax v4 codebase (including font data) into a single ~4.1 MB JavaScript file, then run it in-process via the `quickjs` Python C extension. The full LaTeX → SVG pipeline executes within the Python process's memory — no Node.js runtime or subprocess calls required.

**Tech Stack**:

| Component | Technology | Version |
|-----------|-----------|---------|
| JS rendering engine | MathJax (`mathjax-full`) | 4.0.0-beta.7 |
| Font data | `mathjax-modern-font` | Auto-installed with mathjax-full |
| Embedded JS engine | QuickJS (via `quickjs` Python lib) | 1.19.4+ |
| JS bundler | esbuild | 0.20+ |
| DOM emulation | MathJax `liteAdaptor` | — |

---

## 2. Directory Structure

```
QuickJax/
├── quickjax/                   # Python package (published to PyPI)
│   ├── __init__.py             # Exports: render, MathJaxRenderer, MathJaxRenderError
│   ├── backend.py              # Core: QuickJS context management + render calls
│   └── js/
│       └── mathjax_bundle.js   # Pre-built MathJax IIFE bundle (~4.1 MB)
│
├── renderer_src/               # JS source (build-time only, not distributed via pip)
│   ├── index.js                # JS entry: initializes MathJax + exposes render API
│   ├── package.json            # npm dependency declarations
│   └── node_modules/           # Generated by npm install (.gitignored)
│
├── tests/
│   └── test_render.py          # pytest test suite (13 tests)
│
├── build_bundle.sh             # One-step build script
├── demo.py                     # 155-expression rendering demo
├── pyproject.toml              # Python package configuration
├── SPECS.md                    # Original technical specification
├── README.md                   # User-facing documentation
├── DEVELOPMENT.md              # This file
└── .gitignore
```

---

## 3. Architecture & Data Flow

```
User call
  │
  ▼
quickjax.render(r"\frac{a}{b}")          ← Python public API
  │
  ▼
MathJaxRenderer.render()                 ← backend.py
  │  json.dumps(latex) → JS string literal
  │  Build expression: globalThis.render("\\frac{a}{b}")
  │
  ▼
quickjs.Context.eval(js_expr)            ← quickjs C extension calls QuickJS
  │
  ▼
globalThis.render(latex)                 ← Function inside mathjax_bundle.js
  │
  ▼
MathJax TeX → MathML → SVG pipeline     ← mathjax-full internals
  │  TeX input parser → internal MathML tree
  │  SVG output jax → liteAdaptor virtual DOM → SVG nodes
  │
  ▼
extractSvg(containerNode)               ← Extract <svg> from <mjx-container>
  │
  ▼
Returns "<svg ...>...</svg>"             → Back to Python as str
```

**Key insight**: MathJax's `convert()` method returns an `<mjx-container>` virtual DOM node that wraps the actual `<svg>` child node. We extract only the `<svg>` part via `extractSvg()` in JS to ensure the output is a valid SVG document.

---

## 4. JavaScript Layer

### 4.1 Entry File: `renderer_src/index.js`

The file is divided into the following logical sections:

#### 4.1.1 MathJax Core Imports

```js
import { mathjax } from "mathjax-full/mjs/mathjax.js";
import { TeX } from "mathjax-full/mjs/input/tex.js";
import { SVG } from "mathjax-full/mjs/output/svg.js";
import { liteAdaptor } from "mathjax-full/mjs/adaptors/liteAdaptor.js";
import { RegisterHTMLHandler } from "mathjax-full/mjs/handlers/html.js";
```

**Note**: MathJax v4 beta uses the `mjs/` directory (ESM format), not `js/`. If MathJax releases a stable version in the future, paths may change.

#### 4.1.2 TeX Extension Imports (23 total)

Each extension self-registers by importing its `*Configuration.js` file. MathJax v4 beta has no unified `AllPackages` export, so each must be imported individually.

Currently loaded extensions:
`ams`, `newcommand`, `boldsymbol`, `braket`, `cancel`, `color`, `enclose`, `extpfeil`, `html`, `mhchem`, `noerrors`, `noundefined`, `physics`, `mathtools`, `amscd`, `action`, `bbox`, `unicode`, `verb`, `textmacros`, `textcomp`, `cases`

#### 4.1.3 Dynamic Font File Pre-loading (26 files)

MathJax v4 loads font data on demand. In browsers this is asynchronous, but QuickJS is a purely synchronous engine with no `Promise` support. When MathJax encounters an unloaded font, it throws a `retryAfter()` exception, causing the render to fail.

**Solution**: Statically import all 26 dynamic font files at bundle time, then:

```js
mathjax.asyncLoad = (name) => {};         // Disable async loading (no-op)
mathjax.asyncIsSynchronous = true;        // Tell MathJax async ops are actually sync
svgOutput.font.loadDynamicFilesSync();    // Synchronously load all imported font data
```

This is the main reason the bundle grew from 1.2 MB to 4.1 MB — font path data accounts for ~3 MB.

#### 4.1.4 MathJax Document Initialization

```js
const texInput = new TeX({ packages });
const svgOutput = new SVG({
  fontCache: "local",                    // Embed <defs> font paths in each SVG
  linebreaks: { inline: false },         // Disable inline math auto line-breaking
});
const htmlDoc = mathjax.document("", {
  InputJax: texInput,
  OutputJax: svgOutput,
});
```

- `fontCache: "local"` ensures each SVG carries its own `<defs>` font definitions with no external files needed.
- `linebreaks: { inline: false }` disables MathJax v4's default inline math auto line-breaking. Without this, inline formulas may be split into multiple `<svg>` elements.

#### 4.1.5 Render Functions

```js
function extractSvg(containerNode) {
  const children = adaptor.childNodes(containerNode);
  for (const child of children) {
    if (adaptor.kind(child) === "svg") {
      return adaptor.outerHTML(child);
    }
  }
  return adaptor.innerHTML(containerNode);
}

globalThis.render = function render(latex) {
  const node = htmlDoc.convert(latex, { display: true, containerWidth: 1e7 });
  return extractSvg(node);
};
```

- `containerWidth: 1e7` sets an extremely large container width to further prevent any potential line-breaking.
- `extractSvg()` iterates `<mjx-container>` child nodes to find `<svg>` and returns only the pure SVG markup.

### 4.2 npm Dependencies

```json
{
  "dependencies": {
    "mathjax-full": "4.0.0-beta.7"
  },
  "devDependencies": {
    "esbuild": "^0.20.0"
  }
}
```

> **Important**: `mathjax-full` uses the exact version `4.0.0-beta.7`, not a range. MathJax v4 stable has not been released; incompatible changes may exist between beta versions. Always test thoroughly when upgrading.

---

## 5. Python Layer

### 5.1 `backend.py` — MathJaxRenderer Class

#### QuickJS Context Configuration

```python
self._ctx = quickjs.Context()
self._ctx.set_max_stack_size(4 * 1024 * 1024)   # 4 MB stack
self._ctx.set_memory_limit(128 * 1024 * 1024)    # 128 MB heap
```

- **4 MB stack**: MathJax bundle evaluation (`eval`) has a deep call stack; the default stack size is insufficient.
- **128 MB heap**: MathJax uses roughly 30–50 MB after initialization; this provides headroom.

#### LaTeX Escaping

```python
escaped = json.dumps(latex)  # "E = mc^2" → '"E = mc^2"'
```

`json.dumps()` produces a valid JS string literal, automatically handling backslashes, quotes, and other special characters.

#### Error Handling

JS-layer `throw new Error(...)` is caught as a Python exception by QuickJS, then wrapped as `MathJaxRenderError`.

### 5.2 `__init__.py` — Public API

Exports three names: `MathJaxRenderer`, `MathJaxRenderError`, `render`.

The module-level `render()` function uses a lazy singleton pattern — the `MathJaxRenderer` instance is created on the first call (~0.3 s) and reused for subsequent calls.

---

## 6. Build Process

### 6.1 `build_bundle.sh`

```bash
cd renderer_src
npm install --silent                    # Install mathjax-full + esbuild
npx esbuild index.js \
  --bundle \                            # Bundle all imports
  --minify \                            # Minify output
  --platform=browser \                  # No Node.js built-in modules
  --format=iife \                       # Self-executing function format (not ESM)
  --outfile=../quickjax/js/mathjax_bundle.js
```

**Key flags explained**:

| Flag | Reason |
|------|--------|
| `--platform=browser` | QuickJS has no `fs`, `path`, etc. — browser platform prevents esbuild from injecting Node polyfills |
| `--format=iife` | QuickJS does not support ESM `import`/`export`; must bundle as IIFE |
| `--minify` | Reduces ~12 MB source to ~4.1 MB |

### 6.2 When to Rebuild

- After modifying `renderer_src/index.js`
- After upgrading the `mathjax-full` version
- After adding/removing TeX extensions or font files

The generated `quickjax/js/mathjax_bundle.js` is tracked by Git to ensure `pip install` works without Node.js.

---

## 7. Key Technical Decisions & Pitfalls

### 7.1 MathJax v4 Version Selection

**Problem**: `mathjax-full@^4.0.0` does not exist on npm. At development time, the latest version was `4.0.0-beta.7`.

**Decision**: Pin the exact version `4.0.0-beta.7`.

**Consequence**: When MathJax v4 stable is released, compatibility testing will be needed and import paths may need adjustment.

### 7.2 ESM Directory: `mjs/` vs `js/`

**Problem**: MathJax v4 beta's ESM modules are under `mjs/`, not the commonly documented `js/`.

**Solution**: All import paths use `mathjax-full/mjs/...`.

### 7.3 No AllPackages Unified Export

**Problem**: MathJax v3's `AllPackages` does not exist in v4 beta.

**Solution**: Manually import 23 extension Configuration files. Each self-registers into MathJax's extension system upon import.

### 7.4 Dynamic Font Loading & QuickJS Synchronous Limitation

**Problem**: MathJax v4 loads fonts on demand (`\mathbb`, `\mathfrak`, etc. trigger loading). The mechanism uses `retryAfter(asyncFunction)` — essentially an async retry pattern. QuickJS does not support async operations.

**Symptom**: Rendering `\mathbb{R}` throws "MathJax retry" or similar errors.

**Solution**:
1. Statically import all 26 dynamic font files in the bundle (they self-register into the font registry at module load time).
2. Set `mathjax.asyncLoad` to a no-op and `mathjax.asyncIsSynchronous = true`.
3. Call `svgOutput.font.loadDynamicFilesSync()` to synchronously load all font data into memory.

**Trade-off**: Bundle size grew from 1.2 MB → 4.1 MB (font path data accounts for ~3 MB).

### 7.5 `<mjx-container>` Wrapper & Inline Line-breaking

**Problem**: MathJax's `convert()` returns an `<mjx-container>` virtual node, not a pure `<svg>`. Additionally, v4 enables inline math auto line-breaking by default (`linebreaks.inline: true`), causing a single inline formula to be split into multiple `<svg>` elements.

**Solution**:
1. Add `linebreaks: { inline: false }` to the `SVG` constructor options to disable inline line-breaking.
2. Use `extractSvg()` in JS to extract the first `<svg>` child element from the container node.
3. Set `containerWidth: 1e7` as extra insurance — an extremely large container width.

### 7.6 Case-sensitive Filenames

**Problem**: `TextmacrosConfiguration.js` — the actual filename is `TextMacrosConfiguration.js` (capital M). Import paths are case-sensitive on Linux, causing build failures.

**Solution**: Correct the casing.

---

## 8. Testing

### 8.1 Unit Tests

```bash
pytest tests/ -v
```

13 tests covering:

| Test Class | Coverage |
|------------|----------|
| `TestBasicRender` | Basic equations, inline mode, fractions, integrals, matrices |
| `TestSVGSelfContained` | No external href references, SVG tag presence |
| `TestContextReuse` | Multiple renders reuse context; results are correct and distinct |
| `TestEscaping` | Backslashes, curly braces, quotes, and other special characters |
| `TestConvenienceFunction` | Module-level `render()` + inline mode |

### 8.2 Demo Tests

```bash
python demo.py
```

`demo.py` contains 155 LaTeX expressions across 25 categories: arithmetic, Greek letters, calculus, linear algebra, set theory, logic, statistics, mhchem chemical equations, physics macros, font commands (`\mathbb`, `\mathfrak`, `\mathcal`), large formulas, etc.

---

## 9. Publishing & Packaging

### 9.1 Building Distribution Packages

```bash
# Ensure the bundle is built
bash build_bundle.sh

# Build sdist + wheel
pip install build
python -m build
```

The `pyproject.toml` configuration ensures `quickjax/js/mathjax_bundle.js` is included in the wheel:

```toml
[tool.setuptools.package-data]
quickjax = ["js/*.js"]
```

### 9.2 Publishing to PyPI

```bash
pip install twine
twine upload dist/*
```

### 9.3 Version Management

The version number is defined in two places; both must be updated in sync:
- `pyproject.toml` → `version = "0.1.0"`
- `quickjax/__init__.py` → `__version__ = "0.1.0"`

---

## 10. Troubleshooting

### "MathJax retry" Error

**Cause**: A font file was not pre-loaded.

**Steps**:
1. Check the font name mentioned in the error message.
2. Look for the corresponding file under `node_modules/mathjax-modern-font/mjs/svg/dynamic/`.
3. Add the corresponding `import` statement in `index.js`.
4. Re-run `bash build_bundle.sh`.

### QuickJS Stack Overflow

**Cause**: 4 MB stack space is insufficient.

**Fix**: Increase `set_max_stack_size` in `backend.py`.

### QuickJS Out of Memory

**Cause**: 128 MB heap space is insufficient (extremely rare).

**Fix**: Increase `set_memory_limit` in `backend.py`.

### Unrecognized TeX Commands

**Cause**: The corresponding TeX extension is not loaded.

**Fix**:
1. Find which MathJax TeX extension the command belongs to.
2. Add `import "mathjax-full/mjs/input/tex/<ext>/<Ext>Configuration.js"` in `index.js`.
3. Add the extension name to the `packages` array.
4. Rebuild.

### Empty or Malformed SVG Output

**Steps**:
1. Check if the JS layer works: `python -c "from quickjax import MathJaxRenderer; r = MathJaxRenderer(); print(r.render(r'x^2'))"`
2. Verify the output starts with `<svg` and ends with `</svg>`.
3. If the output is an empty `<svg></svg>`, the issue may be with the `fontCache` setting.

---

## 11. Extension Guide

### Adding New TeX Extensions

1. Confirm the extension is available in `mathjax-full`: check for a corresponding directory under `node_modules/mathjax-full/mjs/input/tex/`.
2. Add the `import` statement in `index.js`.
3. Add the extension identifier to the `packages` array.
4. Rebuild and test.

### Upgrading MathJax Version

1. Update the `mathjax-full` version in `renderer_src/package.json`.
2. Delete `renderer_src/node_modules/` and `renderer_src/package-lock.json`.
3. Run `bash build_bundle.sh`.
4. Run `pytest tests/ -v` and `python demo.py` to verify.
5. **Watch out for**:
   - MathJax stable v4 may rename `mjs/` to `js/` — check import paths.
   - The font package name may change from `mathjax-modern-font` — check the actual dependency in `package.json`.
   - `AllPackages` may return in the stable release, allowing simplified extension imports.

### Supporting MathML Input (Future Option)

MathJax also supports MathML input. If needed:

1. Import the `MathML` input jax in `index.js`.
2. Create a new `mathjax.document` or replace `texInput`.
3. Expose a new `globalThis.renderMathML(mml)` function.
4. Add corresponding API in the Python layer.

### Adjusting QuickJS Resource Limits

If rendering extremely complex formulas hits resource limits:

```python
# Modify in backend.py
self._ctx.set_max_stack_size(8 * 1024 * 1024)   # 8 MB stack
self._ctx.set_memory_limit(256 * 1024 * 1024)    # 256 MB heap
```

---

## Appendix: File Reference

| File | Purpose | Size (approx.) |
|------|---------|----------------|
| `quickjax/js/mathjax_bundle.js` | Pre-built JS bundle | ~4.1 MB |
| `renderer_src/index.js` | JS source entry | ~4 KB |
| `quickjax/backend.py` | Python core implementation | ~3 KB |
| `quickjax/__init__.py` | Package exports | ~0.2 KB |
| `tests/test_render.py` | Test suite | ~3 KB |
| `demo.py` | Rendering demo | ~6 KB |
